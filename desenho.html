<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    * {
      -webkit-user-select: none;
      -moz-user-select: -moz-none;
      /*IE10*/
      -ms-user-select: none;
      user-select: none;
      /*You just need this if you are only concerned with android and not desktop browsers.*/
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }

    body {
      text-shadow: -1px 0 #bbbbbbbb, 0 1px #bbbbbbbb, 1px 0 #bbbbbbbb, 0 -1px #bbbbbbbb;
      overflow-y: hidden;
      padding: 0px 0px;
      margin: 0px 0px;
      font-family: "emojione mozilla", "segoe ui emoji", "noto color emoji",
        "android emoji", "emojisymbols", "segoe ui symbol" "twemoji mozilla",
        "apple color emoji";
    }

    #desenho_div {
      text-align: center;
      display: block;
      margin-left: auto;
      margin-right: auto;
      width: 360px;
      touch-action: manipulation;
    }

    #canvas_div {
      background-image: url("./grid3.png");
      text-align: center;
      display: block;
      margin-left: auto;
      margin-right: auto;
      width: 320px;
      height: 320px;
      overflow-y: hidden;
    }

    #canvas_div2 {
      background-image: url("./grid.png");
      text-align: center;
      display: block;
      margin-left: auto;
      margin-right: auto;
      width: 320px;
      height: 320px;
      overflow-y: hidden;
    }

    #canvas_window {
      overflow: scroll;
      width: 342px;
      height: 342px;
      -webkit-touch-overflow: scroll;
      margin-left: auto;
      margin-right: auto;
    }

    #paleta {
      position: relative;
      width: 160px;
      height: 150px;
      display: block;
      top: 0px;
      margin-top: 0px;
      display: block;
      float: left;
    }

    #paleta2 {
      position: relative;
      width: 160px;
      height: 110px;
      display: block;
      top: 4px;
      margin-top: 0px;
      display: block;
      float: left;
    }

    #menucores {
      width: 290px;
      height: 290px;
      z-index: 3;
    }

    #menu {
      font-kerning: 1.2 em;
      width: 92px;
      height: 272px;
      display: block;
      float: right;
      font-size: larger;
      text-align: center;
    }

    .submenu {
      position: absolute;
      display: block;
      top: 54px;
      width: 280px;
      height: 80px;
      padding: 8px;
      z-index: 3;
      visibility: hidden;
    }

    .fundobranco {
      margin: 2px;
      min-height: 32px;
      background-color: #eeeeee66;
      border-radius: 20px;
      border-style: solid;
      border-width: 2px;
      border-color: #dddddddd;
      padding: 4px;
      display: inline-block;
    }

    .fundobranco2 {
      min-height: 12px;
      display: inline-block;
      float: left;
      margin: 4px 4px 0px 4px;
    }

    .bloquinho {
      margin: 4px;
      width: 20px;
      height: 20px;
      border-style: solid;
      border-radius: 20px;
      border-color: #55555555;
      border-width: thin;
      display: block;
      float: left;
      padding: 2px;
      font-size: 1.125em;
      margin: 1px 2px 1px 2px;
      touch-action: manipulation;
    }

    .selected {
      background-color: #00000044;
      border-color: #dd5555;
      border-width: 3px;
      width: 16px;
      height: 16px;
      padding-left: -10px;
      font-size: 1.5em;
    }

    #mostraCor {
      width: 50px;
      height: 50px;
      border-style: solid;
      border-radius: 200px;
      border-color: gray;
      border-width: thin;
      padding: 0px;
      font-size: 1.125em;
      float: left;
      text-align: center;
      background-color: "hsl(0, 100%, 0%)";
      margin: 4px 4px 4px 4px;
      font-size: 50px;
      text-align: center;
      line-height: 50px;
      display: block;
    }

    .linha {
      width: 1px;
      border-radius: 0px;
    }

    #mostraCor2 {
      width: 2px;
      height: 2px;
      border-style: solid;
      border-radius: 200px;
      border-color: gray;
      border-width: thin;
      display: block;
      padding: 0px;
      font-size: 1.125em;
      float: left;
      margin-left: 10px;
    }

    #cursor {
      pointer-events: none;
      display: block;
      position: absolute;
      width: 2px;
      height: 2px;
      border-style: solid;
      border-radius: 200px;
      border-color: gray;
      color: #00000055;
      border-width: thin;
      padding: 0px;
      font-size: 1.5em;
      z-index: 10;
    }

    .disable-scroll {
      overflow-y: hidden;
    }

    .aparece {
      visibility: visible;
    }

    .naotoque {
      user-select: none;
      -moz-user-select: none;
      -khtml-user-select: none;
      -webkit-user-select: none;
      -o-user-select: none;
    }

    .cursorIndex {
      z-index: 0;
    }

    range {
      margin-bottom: 10px;
      margin-top: 10px;
    }

    .pqno {
      height: 24px;
      width: 24px;
    }

    .pixel {
      image-rendering: pixelated;
    }

    input[type="range"][orient="vertical"] {
      writing-mode: bt-lr;
      /* IE */
      -webkit-appearance: slider-vertical;
      /* Chromium */
      width: 8px;
      height: 175px;
      padding: 0 5px;
      float: left;
      margin-top: 4px;
    }

    #menus {
      margin-left: 0px;
    }

    #ferramentas {
      width: 310px;
      margin-left: 4px;
    }

    #menuinfo {
      overflow-y: scroll;
      height: 300px;
      width: 300px;
    }

    .day {
      background-color: #ddddddcc;
    }

    .night {
      background-color: #111111cc;
      border-color: #333333ee;
    }

    .custom-file-input::before {
      content: 'üì∑';
      display: inline-block;
      background: linear-gradient(top, #f9f9f9, #e3e3e3);
      border: 1px solid #999;
      border-radius: 3px;
      padding: 5px 8px;
      outline: none;
      white-space: nowrap;
      -webkit-user-select: none;
      cursor: pointer;
      text-shadow: 1px 1px #fff;
      font-weight: 700;
      font-size: 10pt;
    }

    .destination-over {
      z-index: 3;
    }
  </style>
  <title>Diego Desenha - Alpha</title>
</head>

<body class="naotoque day" style="cursor: pointer;">
  <div id="desenho_div" style="overflow-y: hidden; width: 1050px; height: 609px;" class="naotoque">
    <div id="menus">
      <div id="menupicker" class="submenu fundobranco">
        Toque numa √°rea pintada<br>
        para capturar uma cor
      </div>
      <div id="menuinfo" class="submenu fundobranco">
        <small> Desenha CC Credits:<br>
          <a href="https://diegoferraribruno.github.io/">Diego F. Bruno</a><br>twitter @diegofbrasil<br>
          <a href="https://leimao.github.io/blog/HTML-Canvas-Mouse-Touch-Drawing/" target="_blank">
            lei mao</a>
          <br>
          vers√£o 0.5.8 <br>
          - webcam <br>
          - (bug) precisa aguardar carregar a imagem antes de seguir no undo()
          <br>
          vers√£o 0.5.7<br>
          - ruidos removidos<br>
          vers√£o 0.5.6<br>
          - foto e fundo com tamanho<br>
          vers√£o 0.5.5<br>
          - inicia no modo noturno<br>
          - fundo xadrez<br>
          - sons no menu, no Crtl+Z e no Ctrl+Y <br>

          vers√£o 0.5.4<br>
          - multiple images<br>
          vers√£o 0.5.3<br>
          - pinta por cima ou por baixo mode fix.<br>
          - sombra no texto
          vers√£o 0.5.2<br>
          - night mode<br>
          - envia imagem.<br><br>
          ver 0.5 - Turing<br>
          - nova paleta de cores<br><br>
          - tamanhos pre definidos de pinceis. <br>
          - refazer passo a passo. <br>
          - apagador com transparencia propria.<br>
          - lupa com indicador de zoom. no lugar apropriado<br>
          <br>

          0.4.9
          reduzida a quantifdade de undos disponiveis porem salvaremos uma imagem que sera carregada ao fundo
          o que pode influenciar na qualidade do projeto final. vamos ao teste.
          <br>
        </small>
      </div>
      <div id="menuimagem" class="fundobranco submenu aparece">
        üì§ <input type="file" id="input" class="custom-file-input" />

      </div>
      <div id="menupintar" class="fundobranco submenu">
        <span style="float: center; position: relative; width: 70px" onmousedown="changeLine()">estilo:<span id="line">
            ‚ûï</span></span>
        <input type="number" id="tpx" min="0.5" max="100" step="0.5" value="1" onchange="setStrokeSize(this.value)"
          style="width: 50px; margin-left: 8px">
        <input type="range" id="strokeSize" name="strokeSize" min="1" max="26" step="1"
          oninput="strokeSizeRange(this.value)" value="1" width="200px"><br>
        üíß<input type="range" id="A2" name="transparencia" min="0.01" max="1" oninput="mudaCorQ(3,this.value)"
          step="0.01" value="1"><br>
        <span onmousedown="removeClass()" id="mostraCor2"
          style="background-color: rgba(247, 161, 165, 0.15); width: 35px; height: 35px; margin-top: -17.5px; margin-left: -17.5px;">üñåÔ∏è</span>
      </div>
      <div id="menuapagar" class="fundobranco submenu">
        <span style="float: center; position: relative; width: 16px" onmousedown="changeLine()"><span id="line2">
            ‚ûï</span></span>
        <span class="bloquinho" onmousedown="removeClass()">üßΩ</span>&nbsp;<input type="number" id="tpx2" min="0.5"
          max="100" step="0.3" value="1" onchange="setStrokeSize(this.value)" style="width: 50px; margin-left: 8px">
        <input type="range" id="estrokeSize" name="estrokeSize" min="1" max="26" step="1"
          oninput="strokeSizeRange(this.value)" value="1" width="160px">
        <span onmousedown="removeClass()" id="mostraCor2" style="background-color: &#39;hsl(0, 100%, 0%);&#39;">
        </span>
        <div>
          üíß<input type="range" id="transparenciaE" name="transparencia" min="0.1" max="1" oninput="mudaCorAlpha()"
            step="0.1" value="1"></div>
      </div>

      <div id="menucores" class="fundobranco submenu">
        <div id="menu" class="fundobranco" onmouseover="mostra()">
          üåà‚óíüîÜüíß<br>
          <input type="range" orient="vertical" id="H" name="cor" min="0" max="359" oninput="mudaCorQ(0,this.value)"
            value="0">
          <input type="range" orient="vertical" id="S" name="cor" min="0" max="100" oninput="mudaCorQ(1,this.value)"
            value="100">
          <input type="range" orient="vertical" id="L" name="cor" min="0" max="100" oninput="mudaCorQ(2,this.value)"
            value="50">
          <input type="range" orient="vertical" id="A" name="cor" min="0.01" max="1" oninput="mudaCorQ(3,this.value)"
            step="0.01" value="1"><br>
          <div id="salvaCor" onmousedown="salvaCor()" title="Favoritar"
            style="height: 20px; float: left; margin-top: 20px; line-height: 1em; font-size: 1.5em; background-color: rgba(247, 161, 165, 0.15);"
            class="bloquinho">
            <div style="margin: -20px 10px 0px 0px; width: 20px">üìå</div>
          </div>
          <div id="mostraCor" onmousedown="removeClass()"
            style="float: right; color: white; font-family: Arial, Helvetica, sans-serif; font-size: 1.75em; font-weight: bold; background-color: rgba(247, 161, 165, 0.15);">
            ok
          </div>
        </div>
        <div id="paleta" class="fundobranco"></div>
        <div id="paleta2" class="fundobranco">
          <br>use o üìå para guardar <br>ou remover suas cores daqui.
        </div>
      </div>

      <div id="menufundo" class="fundobranco submenu naotoque" style="text-align: center">
        Fundo falso:
        <br>
        <span onmousedown="Fundo('img')" class="bloquinho">üñºÔ∏è</span>
        <span onmousedown="Fundo('black')" class="bloquinho" style="background-color: hsla(0, 100%, 0%, 1)">
        </span>
        <span onmousedown="Fundo('white')" class="bloquinho" style="background-color: hsla(0, 100%, 100%, 1)">
        </span>
        <span onmousedown="Fundo('grid.png')" class="bloquinho"
          style="background-image: url(&#39;./grid.png&#39;)">.</span>
        <span onmousedown="Fundo('grid2.png')" class="bloquinho"
          style="background-image: url(&#39;./grid2.png&#39;); background-color: #fff"></span>
        <span onmousedown="Fundo('grid3.png')" class="bloquinho"
          style="background-image: url(&#39;./grid3.png&#39;)"></span>
        <span onmousedown="Fundo('none')" class="bloquinho" style="background-color: hsla(0, 100%, 100%, 0)">
          ‚ùå</span>
        <br><span>
          üì§ <input type="file" id="input2" class="custom-file-input" />
        </span>
      </div>

      <div id="menupreencher" class="fundobranco submenu">
        ‚ö†Ô∏è Preencher tudo ‚ö†Ô∏è
        <span width="140px" style="margin: 8px 80px; display: block">
          <span onmousedown="mudaCorBG('black')" class="bloquinho" style="background-color: hsla(0, 100%, 0%, 1)">
          </span>
          <span onmousedown="mudaCorBG('white')" class="bloquinho" style="background-color: hsla(0, 100%, 100%, 1)">
          </span>
          <span onmousedown="mudaCorBG('strokeColor')" id="preenchercor" class="bloquinho"
            style="background-color: rgba(158, 239, 129, 0.28);">
          </span>
          <span class="bloquinho" onmousedown="removeClass()" width="120px">‚ùå</span><br>
        </span>
      </div>

      <div id="menuzoom" class="fundobranco submenu">
        <input id="zoombar" type="range" min="0" max="3" value="1" step="1" onchange="ZOOMf(this.value)">
        <input id="tzoom" type="number" min="0.50" max="4" step="0.5" value="1" onchange="ZOOM(this.value)"
          style="width: 44px">
        <span onmousedown="scrollCanva(-80,0)">‚¨ÖÔ∏è</span>
        <span onmousedown="scrollCanva(0,-80)">‚¨ÜÔ∏è</span>
        <span onmousedown="scrollCanva(0,80)">‚¨áÔ∏è</span>
        <span onmousedown="scrollCanva(80,0)">‚û°Ô∏è</span>
      </div>

      <div id="ferramentas" class="fundobranco">
        <span onmousedown="backPaint()" class="fundobranco2" id="globalComposite"
          style="width: 24px; height: 24px; padding-top: 6px"><span
            style="position:absolute; width:30px; display:block; color:white; margin-left:-4px; padding-top:4px;">‚≠ï</span>
          <span
            style="position:relative; float:left; width:30px; display:block;  color:black; left:2px; margin-top:0px;"
            title="Pintando por baixo">üî≤</span></span>
        <span id="pintar" title="pintar" class="bloquinho selected" onmousedown="modeTo('pintar')"
          style="background-color: rgba(247, 161, 165, 0.15);">üñåÔ∏è</span>
        <span id="cores" title="cores" class="bloquinho" onmousedown="modeTo('cores')"
          style="background-color: rgba(247, 161, 165, 0.15);">üé®</span>
        <span id="picker" title="Pega cor" class="bloquinho" onmousedown="modeTo('picker')"
          style="background-color: rgba(247, 161, 165, 0.15);">üíâ</span>

        <span id="preencher" title="Preencher" onmousedown="modeTo('preencher')" class="bloquinho"
          style="background-color: rgba(247, 161, 165, 0.15);">ü™£</span>
        <span id="apagar" title="Apagar" class="bloquinho" onmousedown="modeTo('apagar')">üßΩ</span>
        <span class="bloquinho" title="Redimensionar tela" onclick="x2()">‚ÜîÔ∏è</span>
        <span class="bloquinho" title="Limpar tela" onmousedown="clearArea()">üóë</span>
        <span><a id="btn-download" class="bloquinho"> üì•</a></span>
        <span id="imagem" title="adicionar imagem" class="bloquinho" onmousedown="modeTo('imagem')"> üì§</span>
      </div>
    </div>

    <div id="canvas_window">
      <span id="cursor"
        style="left: 677px; top: 342px; width: 35px; height: 35px; margin-top: -17.5px; margin-left: -17.5px; border-color: rgba(247, 161, 165, 0.15);"
        class="naotoque cursorIndex" onselectstart="return false;" ondragstart="return false;"></span>
      <div id="canvas_div" style="overflow: hidden" class="day">
        <canvas id="canvas" width="320px" height="320px" onmousemove="cursorMove(event)" onmouseout="mostra()"
          class="day" style="z-index: 2;">
          Seu navegador nao suporta o elemento de canvas ou vc est√° offline e algo n√£o carregou corretamente.<br>
          se quiser, salve a pagina no seu computador ou dispositivo e abra o desenho.html diretamente.
        </canvas>
        <canvas id="canvasV" width="480px" height="320px" onmousemove="cursorMove(event)" onmouseout="mostra()"
          style="visibility: hidden; position: absolute; left:0px;">
        </canvas>

      </div>
    </div>
    <div id="ferramentas2" class="fundobranco naotoque" style="width: 280px; margin: auto">

      <span id="fundo" title="Fundo falso" class="bloquinho" onmousedown="modeTo('fundo')">üñºÔ∏è</span>

      <span id="night" class="bloquinho" onmousedown="night()"> üåí</span>
      <span id="oculos" class="bloquinho" onmousedown="pixel()"> üëì</span>

      <span id="zoom" title="Ampliar" class="bloquinho" onmousedown="modeTo('zoom')">üîé<span id="x1"
          style="font-size: 0.6em; display:block; position:absolute; margin-top: -24px; width:20px; height:20px;">1x</span></span>
      <span id="hand" class="bloquinho" onclick="toggleHand()">üñê</span>
      <span id="undo" title="undo" class="bloquinho" onmousedown="undoT()" onmouseup="undoTEnd()">‚Ü©Ô∏è</span>
      <span id="redo" title="replay" class="bloquinho" onmousedown="redoT()" onmouseup="redoTEnd()">‚Ü™Ô∏è</span>
      <span id="info" title="Fundo falso" class="bloquinho" onmousedown="modeTo('info')">‚ÑπÔ∏è</span>
      <span id="cam" title="foto" class="bloquinho" onmousedown="cam()">üì∑</span>
    </div>

  </div>

  <script>
    //style="visibility:hidden"
    const canvas = document.getElementById("canvas");
    const context = canvas.getContext("2d");
    const canvasV = document.getElementById("canvasV");
    const contextV = canvasV.getContext("2d");
    let isDrawing = false;
    let isGrabing = false;
    let x = 0;
    let y = 0;
    var offsetX;
    var offsetY;
    const ongoingTouches = [];

    // comeca minha adaptacao

    const canvasDiv = document.getElementById("canvas_div");
    var globalComposite = "source-over";
    var favoritas = [];
    var stroke = 1;
    var hsla = [0, 100, 50, 1];
    var strokeColor = `hsla(${hsla[0]},${hsla[1]}%,${hsla[2]}%,${hsla[3]})`;
    var strokeWidth = 0.6;
    var estrokeColor = `hsla(${hsla[0]},${hsla[1]}%,${hsla[2]}%,${hsla[3]})`;
    var estrokeWidth = 4;
    var mode = "cores";
    var linejoin = "round";
    var lineJoinsCount = 0;
    const lineJoins = ["round", "miter"];
    var ultimoToque = { x: 160, y: 160 };
    var zoomFactor = 1;
    var zoomScale = [0.5, 1, 2, 4];
    var zoomIndex = 1;
    var mouseOver = false;
    var layer1 = [];
    var x2size = 1;
    const cursor = document.getElementById("cursor");
    const win = document.getElementById("canvas_window");
    const desenhoDiv = document.getElementById("desenho_div");
    const images = []
    var audio = new Audio('./back_001.wav');
    var audio2 = new Audio('./click_005.wav');
    audio.volume = 0.5;
    audio2.volume = 0.5;

    function cam() {
      if (!document.getElementById("video")) {

        const videoE = document.createElement("video");
        videoE.id = "video"
        videoE.setAttribute('style', "position:absolute; margin-left:-160px; margin-top:-325px; z-index:2; opacity: 0.5;")
        videoE.height = 240; // in px
        videoE.width = 320; // in px
        canvasDiv.appendChild(videoE);
        if (context.globalCompositeOperation == "destination-over") {
          console.log("destination-over")
          canvas.classList.toggle("destination-over")
          context.globalCompositeOperation = globalComposite
        }
        navigator.mediaDevices.getUserMedia({ video: true }).then(function (mediaStream) {
          const video = document.querySelector('#video');
          video.srcObject = mediaStream;
          video.play();
        });

        document.querySelector('#video').addEventListener('click', function (e) {
          let proporcao = canvas.width / video.width
          let W = video.width
          let H = video.height
          contextV.drawImage(video, 0, 0, W, H)
          img_b64 = canvasV.toDataURL('image/png');
          //Create blob from DataURL
          blob = dataURItoBlob(img_b64)

          //Insert image

          desenha("f", globalComposite, blob, 0, 0, 320, 320)
          removeElement("video")
          /*
            <button id="upload">Upload</button>
          document.querySelector('#upload').addEventListener('click', function (e) {
     
            var canvas = document.querySelector("#canvas");
     
            canvas.toBlob(function (blob) {
     
              var form = new FormData();
              form.append('image', blob, 'webcam.jpg');
     
              var xhr = new XMLHttpRequest();
              xhr.open('POST', '/upload', true);
              xhr.onload = function (e) {
                // upload conclu√≠do  
              };
     
              xhr.send(form);
     
            }, 'image/jpeg');
          })
          */
        })

      } else {
        removeElement("video")
      }
    }
    function removeElement(id) {
      var elem = document.getElementById(id);
      return elem.parentNode.removeChild(elem);
    }
    function canvasToBlob(context, type) {
      return new Promise(function (resolve, reject) {
        context.canvasV.toBlob(function (blob) {
          resolve(blob);
        }, type);
      });
    }
    //Get data from canvas

    function dataURItoBlob(dataURI) {
      // convert base64/URLEncoded data component to raw binary data held in a string
      var byteString;
      if (dataURI.split(',')[0].indexOf('base64') >= 0)
        byteString = atob(dataURI.split(',')[1]);
      else
        byteString = unescape(dataURI.split(',')[1]);

      // separate out the mime component
      var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];

      // write the bytes of the string to a typed array
      var ia = new Uint8Array(byteString.length);
      for (var i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
      }

      return new Blob([ia], { type: mimeString });
    }

    function prevent(evt) {
      evt.preventDefault();
    }
    function night() {
      let testarray = document.getElementsByClassName("fundobranco");
      let testarray2 = document.getElementsByClassName("day");
      for (let i = 0; i < testarray.length; i++) {
        //testarray[i].className += "night";
        testarray[i].classList.toggle("night")
      } for (let i = 0; i < testarray2.length; i++) {
        //testarray[i].className += "night";
        testarray2[i].classList.toggle("night")
      }
    }
    var input = document.getElementById('input');
    input.addEventListener('change', handleFiles);
    var input2 = document.getElementById('input2');
    input2.addEventListener('change', readURL, true);
    var imagem = new Image;

    function handleFiles(e) {
      imagem = new Image;
      imagem.src = URL.createObjectURL(e.target.files[0]);
      imagem.onload = function () {
        if (imagem.width > canvas.width) {
          let proporcao = canvas.width / imagem.width
          imagem.height = imagem.height * proporcao
          imagem.width = imagem.width * proporcao
          let centerx = canvas.width / 2 - imagem.width / 2
          let centery = canvas.height / 2 - imagem.height / 2
        }
        desenha("i", globalComposite, imagem, 0, 0, imagem.width, imagem.height)
      }
    }
    function readURL() {
      var file = document.getElementById("input2").files[0];
      var reader = new FileReader();
      reader.onloadend = function () {
        var image = new Image();

        image.src = reader.result;

        image.onload = function () {
          if (image.width > canvas.width) {
            let proporcao = canvas.width / image.width
            image.height = image.height * proporcao
            image.width = image.width * proporcao
          }
          canvasDiv.style.backgroundImage = "url(" + reader.result + ")";
          canvasDiv.style.backgroundSize = `${image.width}px ${image.height}px`
        };
      }
      if (file) {
        reader.readAsDataURL(file);
      } else {
      }
    }

    function x2(w = 320, h = 320) {
      let newSize = 320;
      let newSizeb = 320;
      if (x2size < 4) {
        newSize = newSize * x2size;
        newSizeb = newSize * 2;
      } else {
        newSize = 320 * x2size;
        newSizeb = 320;
      }

      var resultado = confirm(
        "\t\t\t\t‚ÜîÔ∏è Deseja mudar o tamanho da tela de \n" +
        `\t\t\t\t\t\t${newSize}px x ${newSize}px\n` +
        `\t\t\t\t\t\t\tpara\n` +
        `\t\t\t\t\t\t${newSizeb}px x ${newSizeb}px\n\n` +
        `\t\t\t\t\t utilize a lupa üîé para zoom \n` +
        `\t\t\t\t e a m√£o üñê para navegar pela tela\n\n`
      );
      if (resultado === true) {
        //dobra o tamanho do canva
        win.style.width = parseInt(window.innerWidth, 10) - 20 + "px";
        win.style.height = parseInt(window.innerHeight, 10) - 100 + "px";
        x2size *= 2;
        if (x2size > 4) {
          x2size = 1;
          win.style.width = `340px`;
          win.style.height = `340px`;
        }
        let W = w * x2size;
        let H = h * x2size;
        canvasDiv.style.width = W + 30 + "px";
        canvasDiv.style.height = H + 20 + "px";
        canvas.width = W;
        canvas.height = H;
      }
      replay();
    }
    function toggleHand() {
      if (mode != "zoom") {
        oldMode = mode;
        mode = "zoom";
        toggleSelect("hand");
        cursorColor("zoom");
      } else {
        modeTo(oldMode);
        cursorColor(oldMode);
      }
    }
    // pausa na adaptacao funcoes novas ao fim

    document.addEventListener("DOMContentLoaded", startup);
    function resizeScreen() {
      desenhoDiv.style.width = window.innerWidth + "px";
      desenhoDiv.style.height = window.innerHeight + "px";
    }
    function startup() {
      night()
      modeTo("pintar")
      removeClass();
      document.getElementById(
        "globalComposite"
      ).innerHTML =
        `<span style="position:absolute; float:right; width:32px; display:block; ` +
        `padding-top: 0px;">üî≤</span> <span style="color:white;` +
        `position:relative;  display:block; float:left; width:20px; margin-top:-5px;" title="Pintando por cima">‚≠ï</span> `;
      window.addEventListener("resize", function (event) {
        resizeScreen();
      });
      resizeScreen();
      document.getElementById("undo").addEventListener(
        "touchstart",
        (event) => {
          event.preventDefault();
          undoT();
        },
        false
      );
      document.getElementById("undo").addEventListener(
        "touchend",
        (event) => {
          event.preventDefault();
          undoTEnd();
        },
        false
      );
      document.getElementById("redo").addEventListener(
        "touchstart",
        (event) => {
          event.preventDefault();
          redoT();
        },
        false
      );
      document.getElementById("redo").addEventListener(
        "touchend",
        (event) => {
          event.preventDefault();
          redoTEnd();
        },
        false
      );
      document.getElementById("zoombar").value =
        zoomScale.indexOf(zoomFactor);
      window.addEventListener("keydown", handleKeys);
      canvas.addEventListener("touchstart", handleStart);
      desenhoDiv.addEventListener("gesturestart", prevent);
      win.addEventListener("touchmove", prevent);
      canvas.addEventListener("touchend", handleEnd);
      canvas.addEventListener("touchcancel", handleCancel);
      canvas.addEventListener("touchmove", handleMove);
      canvas.addEventListener("mousedown", (e) => {
        x = e.offsetX;
        y = e.offsetY;
        if (mode != "picker" && mode != "zoom") {
          isDrawing = true;
        } else if (mode == "zoom") {
          isGrabing = true;
        }
        removeClass();
      });
      canvas.addEventListener("mouseenter", (e) => {
        mouseOver = true;
      });
      canvas.addEventListener("mouseout", (e) => {
        mouseOver = false;
        setTimeout(() => {
          if (mouseOver == false) {
            isDrawing = false;
            isGrabing = false;
          }
        }, 500);
      });
      canvas.addEventListener("mousemove", (e) => {
        if (isDrawing && mode != "picker") {
          desenha(
            "p",
            context.globalCompositeOperation,
            x,
            y,
            e.offsetX,
            e.offsetY,
            strokeColor,
            stroke,
            linejoin
          );
        } else if (isGrabing) {
          ultimoToque.y = e.offsetY;
          ultimoToque.x = e.offsetX;
          scrollCanva(
            (x - ultimoToque.x) * zoomFactor,
            (y - ultimoToque.y) * zoomFactor
          );
        }
        x = e.offsetX;
        y = e.offsetY;
      });
      canvas.addEventListener("mouseup", (e) => {
        if (isDrawing && mode != "picker") {
          desenha(
            "p",
            context.globalCompositeOperation,
            x,
            y,
            e.offsetX + 1,
            e.offsetY + 1,
            strokeColor,
            stroke,
            linejoin
          );
          ultimoToque.y = e.offsetY;
          ultimoToque.x = e.offsetX;
          x = 0;
          y = 0;
          isDrawing = false;
        } else if (mode == "picker") {
          x = e.offsetX;
          y = e.offsetY;
          var imageData = context.getImageData(x, y, 1, 1).data;
          if (imageData[3] > 1) {
            RGBAToHSLA(
              imageData[0],
              imageData[1],
              imageData[2],
              imageData[3]
            );
            setStrokeColor();
          }
        } else if (mode == "zoom") {
          isGrabing = false;
        }
      });
      document
        .getElementById("btn-download")
        .addEventListener("click", function (e) {
          //var dataURL = canvas.toDataURL("image/jpeg", 1.0);
          let nome = prompt("nome da arte:", "desenho");
          if (nome != null && nome != "") {
            var dataURL = canvas
              .toDataURL("image/png")
              .replace("image/png", "image/octet-stream");
            //downloadImage(dataURL, 'my-canvas.jpeg');
            downloadImage(dataURL, `${nome}.png`);
          }
        });
      initStrokeRange()
    }

    const RGBAToHSLA = (r, g, b, a) => {
      r /= 255;
      g /= 255;
      b /= 255;
      a /= 255;
      const l = Math.max(r, g, b);
      const s = l - Math.min(r, g, b);
      const h = s
        ? l === r
          ? (g - b) / s
          : l === g
            ? 2 + (b - r) / s
            : 4 + (r - g) / s
        : 0;
      const H = Math.floor(60 * h < 0 ? 60 * h + 360 : 60 * h);
      const S = Math.floor(
        100 * (s ? (l <= 0.5 ? s / (2 * l - s) : s / (2 - (2 * l - s))) : 0)
      );
      const L = Math.floor((100 * (2 * l - s)) / 2);
      const A = a;
      hsla[0] = H;
      hsla[1] = S;
      hsla[2] = L;
      hsla[3] = A;
      return `hsla(${H},${S}%,${L}%,${a})`;
    };

    function handleKeys(evt) {
      if (evt.ctrlKey && evt.key === "y") {
        redo();
      }
      if (evt.ctrlKey && evt.key === "z") {
        undo();
      }
    }
    var comandos = [];
    var comandosb = [];
    let desfazendo = false;
    let refazendo = false;
    var counter;
    function undoT() {
      counter = setInterval(() => undo(), 10);
    }
    function undoTEnd() {
      clearInterval(counter);
    }

    function undo() {
      let len = comandos.length;

      if (len > 0) {
        comandosb.unshift(comandos[len - 1]);
        // Remove the most recent command from the list
        comandos.splice(-1, 1);
      } else {
        clearInterval(counter)
        audio.play();
        //alert("nivel maximo de desfazer atingindo.");
        clearInterval(counter)
      }

      // Clear canvas get last flat img
      // Re-play all commands (re-draw canvas from scratch)
      comandosExec()

    }
    function redoT() {
      counter = setInterval(() => redo(), 10);
    }
    function redoTEnd() {
      clearInterval(counter);
    }

    function redo() {
      let len = comandosb.length;

      if (len > 0) {
        comandos.push(comandosb[0]);
        // Remove the most recent command from the list
        comandosb.shift();
      } else {
        clearInterval(counter)
        audio.play();
        //alert("nivel maximo de refazer atingindo.");
        clearInterval(counter)
      }

      // Clear canvas get last flat img
      // Re-play all commands (re-draw canvas from scratch)
      comandosExec()

    }
    function memoryswipe() {
      let len = comandos.length;
      if (len > 200) {
        comandosb = [];
        for (i = 0; i < 100; i++) {
          comandosb.unshift(comandos[len - i - 1]);
          // Remove the most recent command from the list
          comandos.splice(-1, 1);
        }
        convertToImg()
        comandosExec()
        comandos = []
        replay()
      }
    }

    function comandosExec() {
      addFlatedImg();
      setTimeout(() => {
        let lenc = comandos.length;
        for (i = 0; i < lenc; i++) {
          switch (comandos[i][0]) {
            case "p":
              drawLine(
                comandos[i][1],
                comandos[i][2],
                comandos[i][3],
                comandos[i][4],
                comandos[i][5],
                comandos[i][6],
                comandos[i][7],
                comandos[i][8]
              );
              break;
            case "f":
              let myImg = document.createElement("img");
              myImg.src = URL.createObjectURL(comandos[i][2])
              let gco = comandos[i][1]
              myImg.onload = function () {
                let globaltemp = context.globalCompositeOperation
                context.globalCompositeOperation = gco;
                context.drawImage(
                  myImg,
                  0,
                  0,
                  myImg.width,
                  myImg.height);
                context.globalCompositeOperation = globaltemp
              }
              break;
            case "i":
              context.globalCompositeOperation = comandos[i][1];
              context.drawImage(
                comandos[i][2],
                comandos[i][3],
                comandos[i][4],
                comandos[i][5],
                comandos[i][6]);
              break;
            case "c":
              context.globalCompositeOperation = comandos[i][1];
              context.putImageData(
                comandos[i][2],
                comandos[i][3],
                comandos[i][4],
                comandos[i][5],
                comandos[i][6],
                comandos[i][7],
                comandos[i][8]);
              break;
            case "b":
              //          let comando = [GCO, x, y, eoX, eoY, strokeColor];
              context.globalCompositeOperation = comandos[i][1];
              context.fillStyle = comandos[i][2];
              context.fillRect(0, 0, canvas.width, canvas.height);
              break;
          }
        }
      }, 60)

    }
    function replay() {
      context.clearRect(0, 0, canvas.width, canvas.height);
      let lenb = comandosb.length;
      for (a = 0; a < lenb; a++) {
        comandos.push(comandosb[a]);
      }
      setTimeout(() => comandosExec(), 10)
      comandosb = [];
    }

    function desenha(
      CMD,
      GCO,
      X = undefined,
      Y = undefined,
      eoX = undefined,
      eoY = undefined,
      strokeColor = undefined,
      stroke = undefined,
      linejoin = undefined
    ) {
      let comando = []
      switch (CMD) {

        case "p":
          comando = ["p", GCO, X, Y, eoX, eoY, strokeColor, stroke, linejoin];
          setTimeout(
            comandos.push(comando)
            , 0)
          drawLine(
            comando[1],
            comando[2],
            comando[3],
            comando[4],
            comando[5],
            comando[6],
            comando[7],
            comando[8]

          );
          break;
        case "f":
          comando = ["f", GCO, X, Y, eoX, eoY, strokeColor]
          let myImg = document.createElement("img");
          myImg.src = URL.createObjectURL(blob)
          myImg.onload = function () {
            let oldGCO = context.globalCompositeOperation
            context.globalCompositeOperation = globalComposite
            context.drawImage(
              myImg,
              0,
              0,
              myImg.width,
              myImg.height);
            setTimeout(
              comandos.push(comando)
              , 0)
            context.globalCompositeOperation = oldGCO
          }
          break;
        case "i":
          comando = ["i", GCO, imagem, 0, 0, imagem.width, imagem.height]
          context.drawImage(imagem, 0, 0, imagem.width, imagem.height);
          setTimeout(
            comandos.push(comando)
            , 0)
          break;

        case "b":
          comando = ["b", GCO, X];
          setTimeout(comandos.push(comando), 0)
          context.fillStyle = X; //cor
          context.fillRect(0, 0, canvas.width, canvas.height);
          break;
      }
      comandosb = [];
    }
    function handleStart(evt) {
      evt.preventDefault();
      const touches = evt.changedTouches;
      offsetX = canvas.getBoundingClientRect().left;
      offsetY = canvas.getBoundingClientRect().top;
      x = touches[0].clientX;
      y = touches[0].clientY;
      for (let i = 0; i < touches.length; i++) {
        ongoingTouches.push(copyTouch(touches[i]));
      }

      removeClass();
      if (mode == "zoom") {
        isGrabing = true;
      }
    }

    function handleMove(evt) {
      evt.preventDefault();
      const touches = evt.changedTouches;
      for (let i = 0; i < touches.length; i++) {
        const idx = ongoingTouchIndexById(touches[i].identifier);
        if (idx >= 0) {
          ultimoToque.x = (touches[i].clientX - offsetX) / zoomFactor;
          ultimoToque.y = (touches[i].clientY - offsetY) / zoomFactor;
          if (mode != "zoom" && mode != "picker") {
            (x = (ongoingTouches[idx].clientX - offsetX) / zoomFactor),
              (y = (ongoingTouches[idx].clientY - offsetY) / zoomFactor);

            desenha(
              "p",
              context.globalCompositeOperation,
              x,
              y,
              ultimoToque.x,
              ultimoToque.y,
              strokeColor,
              stroke,
              linejoin
            );
            ongoingTouches.splice(idx, 1, copyTouch(touches[i])); // swap in the new touch record
          }
        }
      }
      if (mode == "picker") {
        const touches = evt.changedTouches;
        for (let i = 0; i < touches.length; i++) {
          const idx = ongoingTouchIndexById(touches[i].identifier);
          if (idx >= 0) {
            var imageData = context.getImageData(
              ultimoToque.x,
              ultimoToque.y,
              1,
              1
            ).data;
            if (imageData[3] > 1) {
              RGBAToHSLA(
                imageData[0],
                imageData[1],
                imageData[2],
                imageData[3]
              );
              setStrokeColor();
            }
          }
        }
      }
      if (mode == "zoom") {
        if (isGrabing) {
          for (let i = 0; i < touches.length; i++) {
            const idx = ongoingTouchIndexById(touches[i].identifier);
            if (idx == 0) {
              scrollCanva(x - touches[0].clientX, y - touches[0].clientY);
              x = touches[0].clientX;
              y = touches[0].clientY;
            }
          }
        }
      }
    }
    function handleEnd(evt) {
      evt.preventDefault();
      const touches = evt.changedTouches;
      for (let i = 0; i < touches.length; i++) {
        let idx = ongoingTouchIndexById(touches[i].identifier);
        if (idx >= 0) {
          context.lineWidth = strokeWidth;
          context.fillStyle = strokeColor;
          ongoingTouches.splice(idx, 1); // remove it; we're done
        }
      }
      if (mode == "zoom") {
        isGrabing = false;
      }
    }

    function handleCancel(evt) {
      evt.preventDefault();
      const touches = evt.changedTouches;
      for (let i = 0; i < touches.length; i++) {
        let idx = ongoingTouchIndexById(touches[i].identifier);
        ongoingTouches.splice(idx, 1); // remove it; we're done
      }
    }

    function copyTouch({ identifier, clientX, clientY }) {
      return { identifier, clientX, clientY };
    }

    function ongoingTouchIndexById(idToFind) {
      for (let i = 0; i < ongoingTouches.length; i++) {
        const id = ongoingTouches[i].identifier;
        if (id === idToFind) {
          return i;
        }
      }
      return -1; // not found
    }

    function drawLine(GCO, x1, y1, x2, y2, strokeColor, stroke, linejoin) {
      context.globalCompositeOperation = GCO;
      context.beginPath();
      context.strokeStyle = strokeColor;
      context.lineWidth = stroke;
      context.lineJoin = linejoin;
      context.moveTo(x1, y1);
      context.lineTo(x2, y2);
      context.closePath();
      context.stroke();
    }

    function clearArea() {
      let confirma = confirm(
        "\t\t\t\t\t Limpar todo o desenho? \n \t\t\t\t\t( imposs√≠vel desfazer isto )"
      );
      if (confirma === true) {
        context.setTransform(1, 0, 0, 1, 0, 0);
        context.clearRect(0, 0, context.canvas.width, context.canvas.height);
        comandosb = [];
        let len = comandos.length;
        for (a = 0; a < len; a++) {
          comandosb.push(comandos[a]);
        }
        comandos = [];
        convertToImg()
      }
    }

    // By diego

    let oldMode = mode;
    function modeTo(qual) {
      switch (qual) {
        case "zoom":
          zoomIndex++;
          if (zoomIndex > 3) {
            zoomIndex = 0;
          }
          ZOOMf(zoomIndex);
          setTimeout(function () {
            document.getElementById("x1").innerHTML = zoomFactor + "x";
            scrollCanva(-620 * zoomFactor, -620 * zoomFactor);
          }, 10);
          cursorColor();
          toggleSelect(qual);
          mode = qual;
          break;
        case mode: //se o modo ja estiver ativo:
          mostraMenu(qual);
          if (qual == "info") {
            modeTo(oldMode);
          }
          break;
        case "apagar":
          removeClass();
          mode = qual;
          oldMode = qual;
          setStrokeSize(estrokeWidth);
          context.globalCompositeOperation = "destination-out";
          mostraMenu(qual);
          cursorColor();
          toggleSelect(qual);
          memoryswipe();
          mudaCorAlpha();
          break;
        case "pintar":
          removeClass();
          mode = qual;
          oldMode = qual;
          setStrokeSize(strokeWidth);
          context.globalCompositeOperation = globalComposite;
          mostraMenu(qual);
          toggleSelect(qual);
          setStrokeColor();
          memoryswipe();
          break;
        case "cores":
          removeClass();
          mode = qual;
          oldMode = qual;
          setStrokeSize(strokeWidth);
          context.globalCompositeOperation = globalComposite;
          mostraMenu(qual);
          toggleSelect(qual);
          setStrokeColor();
          memoryswipe();
          break;
        case "fundo":
          removeClass();
          mode = qual;
          oldMode = qual;
          context.globalCompositeOperation = globalComposite;
          setStrokeSize(strokeWidth);
          mostraMenu(qual);
          toggleSelect(qual);
          break;

        case "preencher":
          mode = qual;
          document.getElementById("preenchercor").style.backgroundColor =
            strokeColor;
          context.globalCompositeOperation = globalComposite;
          removeClass();
          mostraMenu(qual);
          toggleSelect(qual);
          break;
        case "picker":
          mode = qual;
          removeClass();
          toggleSelect(qual);
          break;
        case "info":
          mode = qual;
          removeClass();
          mostraMenu(qual);
          toggleSelect(qual);
          break;
        case "undo":
          undo();
          break;
        case "imagem":
          mode = qual;
          removeClass();
          mostraMenu(qual);
          toggleSelect(qual);
          memoryswipe();
          break;
      }
      cursorColor();
      /*  toggleSelect(qual)
            mostraMenu(qual)
            */
    }

    function toggleSelect(id) {
      removeClass("selected");
      document.getElementById(id).classList.toggle("selected");
    }

    function mostraMenu(id) {
      let quem = document.getElementById("menu" + id);
      quem.classList.toggle("aparece");
    }

    function removeClass(qual = "aparece") {
      //pega quem tem e remove
      Array.from(document.querySelectorAll(`.${qual}`)).forEach(function (
        el
      ) {
        el.classList.remove(`${qual}`);
      });
    }

    // Pinceis Cor e Tamanho

    function criaPaleta() {
      i = 1;
      let paleta = "";
      while (i < 24) {
        let cor = document.getElementById("H").value
        //    let cor = document.getElementById("H").value - (i*3)
        paleta += `<span onmousedown='mudaCor("hsla(${cor},${hsla[1] + i * 2}%,${hsla[2] + i * 2
          }%,${hsla[3]
          })")' class='bloquinho' style='background-color:hsla(${cor},${hsla[1] + i * 2
          }%,${hsla[2] + i * 2}%,${hsla[3] * 2 + 0.2});'> </span>`;
        i++;
      }
      document.getElementById("paleta").innerHTML = paleta;
      document.getElementById("paleta").innerHTML +=
        `<span onmousedown='mudaCor("B")'  class='bloquinho' ` +
        `style='background-color:hsla(0, 100%, 100%, ${hsla[3]})'> </span>`;
      document.getElementById("paleta").innerHTML +=
        `<br /><span onmousedown='mudaCor("P")' class='bloquinho' ` +
        `style='background-color:hsla(0, 100%, 0%, ${hsla[3]})'> </span>`;
    }
    function criaPaleta2() {
      let paleta = "";
      let quantas = favoritas.length;
      for (i = 0; i < quantas; i++) {
        paleta += `<span onmousedown='mudaCor("${favoritas[i]}")' class='bloquinho' style='background-color:${favoritas[i]};'> </span>`;
      }
      document.getElementById("paleta2").innerHTML = paleta;
    }

    let strokeRange = [0.3, 0.5, 0.7, 1, 2]

    function initStrokeRange() {
      let r = 2;
      while (r <= 500) {
        r = r * 1.3;
        strokeRange.push(Math.floor(r))
      }
    }

    function strokeSizeRange(value) {
      setStrokeSize(
        strokeRange[value]
      )
    }
    function setStrokeSize(value) {
      let brushes = ["mostraCor2", "cursor"];
      for (i in brushes) {
        let tamanho = document.getElementById(brushes[i]);
        if (mode == "pintar" || mode == "cores") {
          strokeWidth = value;
          tamanho.style.width = strokeWidth * zoomFactor + "px";
          tamanho.style.height = strokeWidth * zoomFactor + "px";
          tamanho.style.marginTop =
            (strokeWidth / 2) * zoomFactor * -1 + "px";
          tamanho.style.marginLeft =
            (strokeWidth * zoomFactor * -1) / 2 + "px";
          if (i == 0) {
            tamanho.style.backgroundColor = strokeColor;
          }
          stroke = strokeWidth;
          document.getElementById("tpx").value = value;
        } else if (mode == "apagar") {
          estrokeWidth = value;
          tamanho.style.width = estrokeWidth * zoomFactor + "px";
          tamanho.style.height = estrokeWidth * zoomFactor + "px";
          tamanho.style.marginTop =
            (estrokeWidth / 2) * zoomFactor * -1 + "px";
          tamanho.style.marginLeft =
            (estrokeWidth * zoomFactor * -1) / 2 + "px";
          stroke = estrokeWidth;
          document.getElementById("tpx2").value = value;
        }
      }
    }

    function backPaint() {

      if (globalComposite != "destination-over") {
        globalComposite = "destination-over";
        document.getElementById(
          "globalComposite"
        ).innerHTML =
          `<span style="position:absolute; width:30px; ` +
          `display:block; color:white; margin-left:-4px; margin-top:-5px;">‚≠ï</span> ` +
          `<span style="position:relative; float:left; width:30px; display:block;  ` +
          `color:black; left:1px; margin-top:0px;" title="Pintando por baixo">üî≤</span>`;
      } else {
        globalComposite = "source-over";
        document.getElementById(
          "globalComposite"
        ).innerHTML =
          `<span style="position:absolute; float:right; width:32px; display:block; ` +
          `padding-top: 0px;">üî≤</span> <span style="color:white;` +
          `position:relative;  display:block; float:left; width:20px; margin-top:-5px;" title="Pintando por cima">‚≠ï</span> `;
      }
      cursor.classList.toggle("cursorIndex");
      cursor.classList.toggle("selected");
      context.globalCompositeOperation = globalComposite;
      modeTo("pintar")
      removeClass()
    }

    function mudaCorBG(cor) {
      if (cor === "strokeColor") {
        cor = strokeColor;
      }
      if (context.globalCompositeOperation != "destination-out") {
        //context.fillStyle = cor;
        // context.fillRect(0, 0, canvas.width, canvas.height);
        let GCO = context.globalCompositeOperation;
        desenha("b", GCO, cor);
      }
    }

    function mudaCorQ(q = 0, valor) {
      hsla[q] = Number(valor);
      //        if (q == 0){hsla[q]=(hsla[q]*2)%360 }
      setStrokeColor();
      criaPaleta();
    }
    function mudaCorAlpha() {
      let valor = document.getElementById("transparenciaE").value
      strokeColor = `hsla(0, 100%, 0%, ${valor})`
    }
    function salvaCor() {
      if (!favoritas.includes(strokeColor)) {
        favoritas.push(strokeColor);
      } else {
        favoritas = favoritas.filter((item) => item !== strokeColor);
      }
      setTimeout(criaPaleta2(), 20);
    }

    criaPaleta();

    function setStrokeColor() {
      strokeColor = `hsla(${hsla[0]},${hsla[1]}%,${hsla[2]}%,${hsla[3]})`;
      let objs = [
        "mostraCor",
        "salvaCor",
        "mostraCor2",
        "pintar",
        "cores",
        "picker",
        "preencher"
      ];
      let quantos = objs.length;
      for (i = 0; i < quantos; i++) {
        document.getElementById(objs[i]).style.backgroundColor = strokeColor;
      }
    }
    setStrokeColor();

    function mudaCor(valor) {
      if (valor == "P") {
        strokeColor = `hsl(0,100%,0%,${hsla[3]})`;
        document.getElementById("mostraCor").style.color = strokeColor;

        //     document.getElementById("menu").style.visibility = "hidden";
      } else if (valor == "B") {
        strokeColor = `hsla(0,100%,100%,${hsla[3]})`;
        document.getElementById("mostraCor").style.color = strokeColor;
        //     document.getElementById("menu").style.visibility = "hidden";
      } else {
        strokeColor = valor;
        //     document.getElementById("menu").style.visibility = "hidden";
        cursorColor();
      }
      document.getElementById("mostraCor").style.backgroundColor =
        strokeColor;
      document.getElementById("mostraCor2").style.backgroundColor =
        strokeColor;
      document.getElementById("pintar").style.backgroundColor = strokeColor;

      const toHslaObject = (hslaStr) => {
        const [hue, saturation, lightness, alpha] = hslaStr
          .match(/[\d\.]+/g)
          .map(Number);
        document.getElementById("H").value = hue;
        document.getElementById("S").value = saturation;
        document.getElementById("L").value = lightness;
        document.getElementById("A").value = alpha;
        document.getElementById("A2").value = alpha;
        hsla[0] = hue;
        hsla[1] = saturation;
        hsla[2] = lightness;
        hsla[3] = alpha;
      };
      toHslaObject(strokeColor);
      setStrokeColor();
    }
    // Save | Download image from stackoverflow
    // Convert canvas to image added to startup .getElementById("btn-download")

    //function downloadImage(data, filename = 'untitled.jpeg') {
    function downloadImage(data, filename = "untitled.png") {
      var a = document.createElement("a");
      a.href = data;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
    }
    function changeLine() {
      lineJoinsCount++;
      if (lineJoinsCount > 1) {
        lineJoinsCount = 0;
      }
      linejoin = lineJoins[lineJoinsCount];
      if (lineJoinsCount != 0) {
        document.getElementById("line").innerHTML = " ‚ûï";
        document.getElementById("line2").innerHTML = " ‚ûï";
      } else {
        document.getElementById("line").innerHTML = " ‚ö´";
        document.getElementById("line2").innerHTML = " ‚ö´";
      }
    }
    ////// ZOOM and scroling
    function setZoom(zoom, el) {
      transformOrigin = [0, 0];
      el = el || instance.getContainer();
      var p = ["webkit", "moz", "ms", "o"],
        s = "scale(" + zoom + ")",
        oString =
          transformOrigin[0] * 100 + "% " + transformOrigin[1] * 100 + "%";

      for (var i = 0; i < p.length; i++) {
        el.style[p[i] + "Transform"] = s;
        el.style[p[i] + "TransformOrigin"] = oString;
      }

      el.style["transform"] = s;
      el.style["transformOrigin"] = oString;
    }

    function ZOOMf(a) {
      let escala = zoomScale[a];
      ZOOM(escala);
    }
    function ZOOM(a) {
      setZoom(1, canvasDiv);
      resetCanva();
      setTimeout(function () {
        win.scrollTop = 0;
        win.scrollLeft = 0;
      }, 10);
      zoomFactor = Number(a);
      console.log(ultimoToque);
      setTimeout(
        () =>
          scrollCanva(
            ultimoToque.x * zoomFactor - 160,
            ultimoToque.y * zoomFactor - 160
          ),
        30
      );
      setTimeout(() => setZoom(zoomFactor, canvasDiv), 4);

      setStrokeSize(strokeWidth);
      document.getElementById("tzoom").value = zoomFactor;
      document.getElementById("zoombar").value =
        zoomScale.indexOf(zoomFactor);
    }

    function scrollCanva(x, y) {
      win.scrollTop += y;
      win.scrollLeft += x;
    }
    function resetCanva() {
      let objects = ["canvas_window", "canvas_div"];
      for (i in objects.length) {
        document.getElementById(objects[i]).style.width = "320px";
        document.getElementById(objects[i]).style.height = "320px";
      }
    }

    // cursor area //

    function cursorMove(e) {
      var x = e.clientX;
      var y = e.clientY;
      cursor.style.left = x + "px";
      cursor.style.top = y + "px";
      document.body.style.cursor = "none";
    }
    function mostra() {
      document.body.style.cursor = "pointer";
    }

    function cursorColor() {
      switch (mode) {
        case "apagar":
          cursor.style.borderColor = "#cccccccc";
          cursor.innerHTML = "";
          break;
        case "pintar":
          cursor.style.borderColor = strokeColor;
          cursor.innerHTML = "";
          break;
        case "zoom":
          cursor.innerHTML = "üñê";
          break;
        case "picker":
          cursor.innerHTML = "üíâ";
          break;
        default:
          cursor.innerHTML = "";
          cursor.style.borderColor = strokeColor;
      }
    }
    function Fundo(qual) {
      if (qual === "img") {
        var item = prompt(
          "endere√ßo da imagem de fundo",
          "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a1/Alan_Turing_Aged_16.jpg/352px-Alan_Turing_Aged_16.jpg"
        );
        if (item == null || item == "") {
          alert("fundo do app removido");
          canvasDiv.style.backgroundImage = `none`;
        } else {
          canvasDiv.style.backgroundImage = `url(${item})`;
        }
      } else if (qual === "cam") {
        var item = prompt(
          "endere√ßo da imagem de fundo",
          "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a1/Alan_Turing_Aged_16.jpg/352px-Alan_Turing_Aged_16.jpg"
        );
        if (item == null || item == "") {
          alert("fundo do app removido");
          canvasDiv.style.backgroundImage = `none`;
        } else {
          canvasDiv.style.backgroundImage = `url(${item})`;
        }
      } else if (qual === "black") {
        canvasDiv.style.backflatigroundColor = "hsla(0, 100%, 0%, 1)";
      } else if (qual === "white") {
        canvasDiv.style.backgroundColor = "hsla(0, 100%, 100%, 1)";
      } else if (qual === "none") {
        canvasDiv.style.backgroundImage = `none`;
        canvasDiv.style.backgroundColor = "hsla(0, 100%, 100%, 0)";
      } else if (qual === "imagem") {
        canvasDiv.style.backgroundImage = `url(${qual})`;
      }
    }
    function pixel() {
      canvas.classList.toggle("pixel");
      canvasDiv.classList.toggle("pixel");
    }


    let condensado;
    let img;
    convertToImg()
    function convertToImg() {
      img = new Image();
      img.src = canvas.toDataURL()
    }

    function addFlatedImg(x = 0, y = 0) {
      let globaltemp = context.globalCompositeOperation
      context.clearRect(0, 0, canvas.width, canvas.height);
      context.globalCompositeOperation = "destination-over"
      context.drawImage(img, x, y)
      context.globalCompositeOperation = globaltemp

    }

  </script>


</body>

</html>